<!DOCTYPE html>
<html lang="en">
<head>
  <title>ImageClassification</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.0.0/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
  <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>
</head>
<body>
<table id="seitenaufteilung">
  <tr>
    <td id="links">
      <div id="dropzone">
        <span id="dropzone-text">Drop file pls</span>
        <input type="file" name="file" accept="image/*" id="dropzonefile">
      </div>
      <div id="img-area"></div>
    </td>
    <td id="rechts">
      <div id="char-area">
        <canvas id = "mychart" width="400" height="400"></canvas>
      </div>
    </td>
  </tr>
</table>
<table id="beispiele">
  <tr>
    <td><b>Beispiel 1:</b></td>
    <td><b>Beispiel 2:</b></td>
    <td><b>Beispiel 3:</b></td>
    <td><b>Beispiel 4:</b></td>
    <td><b>Beispiel 5:</b></td>
    <td><b>Beispiel 6:</b></td>
  </tr>
  <tr>
    <td><input type="image" src="img/red.png" width="100px" onclick="loadExample(1)" alt="Beispiel 1"></td>
    <td><input type="image" src="img/blue.png" width="100px" onclick="loadExample(2)" alt="Beispiel 2"></td>
    <td><input type="image" src="img/cyan.png" width="100px" onclick="loadExample(3)" alt="Beispiel 3"></td>
    <td><input type="image" src="img/green.png" width="100px" onclick="loadExample(4)" alt="Beispiel 4"></td>
    <td><input type="image" src="img/pink.png" width="100px" onclick="loadExample(5)" alt="Beispiel 5"></td>
    <td><input type="image" src="img/yellow.png" width="100px" onclick="loadExample(6)" alt="Beispiel 6"></td>
  </tr>
</table>
<script>
  let classifier;
  let img;
  let chart = new Chart(document.getElementById("mychart"), {
    type: "bar",
    data: {
      labels: [],
      datasets: [{
        data: [],
      }]
    },
  });

  document.querySelectorAll("#dropzonefile").forEach((inputElement) => {
    const dropZoneElement = inputElement.closest("#dropzone");

    dropZoneElement.addEventListener("click", (e) => {
      inputElement.click();
    });

    inputElement.addEventListener("change", (e) => {
      if (inputElement.files.length) {
        upLoadFile(inputElement.files[0]);
      }
    });

    dropZoneElement.addEventListener("dragover", (e) => {
      e.preventDefault();
    });

    dropZoneElement.addEventListener("drop", (e) => {
      e.preventDefault();
      if (e.dataTransfer.files.length) {
        inputElement.files = e.dataTransfer.files;
        upLoadFile(inputElement.files[0]);
      }
    });
  });

  function preload() {
    classifier = ml5.imageClassifier('MobileNet');
  }

  function setup() {
    let cnvs = createCanvas(400, 400);
    cnvs.parent("img-area");
    cnvs.background(220,220,220,255);
  }

  function upLoadFile(file) {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => {
      img = createImg(reader.result, imageLoaded);
      document.images[0].parentNode.removeChild(document.images[0]);
    }
  }

  function loadExample(example) {
    switch(example) {
      case 1:
        img = loadImage("img/red.png", imageLoaded);
        break;
      case 2:
        img = loadImage("img/blue.png", imageLoaded);
        break;
      case 3:
        img = loadImage("img/cyan.png", imageLoaded);
        break;
      case 4:
        img = loadImage("img/green.png", imageLoaded);
        break;
      case 5:
        img = loadImage("img/pink.png", imageLoaded);
        break;
      case 6:
        img = loadImage("img/yellow.png", imageLoaded);
        break;
    }
  }

  function imageLoaded() {
    image(img, 0, 0, 400, 400);
    classifier.classify(img, gotResult);
  }

  function gotResult(error, results) {
    let loop = chart.data.datasets[0].data.length;
    for(let i = 0; i < loop; i++) {
      chart.data.datasets[0].data.pop();
      chart.data.labels.pop();
    }
    for (let i = 0; i < results.length; i++) {
      chart.data.labels.push(results[i].label);
      chart.data.datasets[0].data.push(results[i].confidence);
    }
    chart.update();
  }

</script>
</body>
</html>
